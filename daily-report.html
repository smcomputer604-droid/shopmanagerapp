<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Sales Report - SM PRINT TECHNOLOGY</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional styles for report page */
        .report-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 90px 20px 40px;
        }
        
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }
        
        .date-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .date-input-container {
            flex: 1;
            min-width: 200px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .summary-card {
            padding: 25px;
            text-align: center;
        }
        
        .summary-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .summary-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .summary-label {
            font-size: 16px;
            color: var(--text-secondary);
        }
        
        .service-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .service-table th {
            background: linear-gradient(to right, var(--primary-color), var(--primary-light));
            color: white;
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .service-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .service-table tr:last-child td {
            border-bottom: none;
        }
        
        .service-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .grand-total {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.2), rgba(39, 174, 96, 0.1));
            border-left: 5px solid #2ecc71;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-top: 30px;
        }
        
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .no-data i {
            font-size: 60px;
            margin-bottom: 20px;
            color: var(--text-light);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(67, 97, 238, 0.2);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .export-buttons {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .export-btn {
            padding: 12px 25px;
            border-radius: var(--border-radius-sm);
            border: none;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .export-btn.print {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
        }
        
        .export-btn.pdf {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
        }
        
        .export-btn.excel {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
        }
        
        .service-icon-cell {
            width: 50px;
            text-align: center;
        }
        
        .amount-cell {
            text-align: right;
            font-weight: 600;
        }
        
        .count-cell {
            text-align: center;
        }
        
        @media print {
            .back-button, .export-buttons, .date-selector button:not(.btn-primary) {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .glass-card, .service-table {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                background: white !important;
            }
            
            .report-container {
                padding: 20px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Back Button -->
    <button class="back-button glass-card" onclick="goBack()">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
    </button>

    <!-- Report Container -->
    <div class="report-container">
        <!-- Header -->
        <div class="section-title">
            <h1>Daily Sales Report</h1>
            <p>View detailed sales report for any date</p>
        </div>
        
        <!-- Date Selection -->
        <div class="glass-card form-container">
            <div class="date-selector">
                <div class="date-input-container">
                    <label class="form-label" for="reportDate">Select Date</label>
                    <input type="date" id="reportDate" class="form-input" value="">
                </div>
                <button class="btn btn-primary" id="loadReportBtn">
                    <i class="fas fa-chart-line"></i> Generate Report
                </button>
                <button class="btn btn-secondary" id="todayReportBtn">
                    <i class="fas fa-calendar-day"></i> Today's Report
                </button>
                <button class="btn btn-secondary" id="yesterdayReportBtn">
                    <i class="fas fa-calendar-minus"></i> Yesterday
                </button>
            </div>
        </div>
        
        <!-- Export Buttons -->
        <div class="export-buttons">
            <button class="export-btn print" onclick="printReport()">
                <i class="fas fa-print"></i> Print Report
            </button>
            <button class="export-btn pdf" onclick="exportToPDF()">
                <i class="fas fa-file-pdf"></i> Save as PDF
            </button>
            <button class="export-btn excel" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Export to Excel
            </button>
        </div>
        
        <!-- Summary Cards -->
        <div class="summary-cards" id="summaryCards" style="display: none;">
            <div class="summary-card glass-card">
                <div class="summary-icon" style="color: #3498db;">
                    <i class="fas fa-store"></i>
                </div>
                <div class="summary-value" id="totalSales">à§³0</div>
                <div class="summary-label">Total Sales</div>
            </div>
            
            <div class="summary-card glass-card">
                <div class="summary-icon" style="color: #2ecc71;">
                    <i class="fas fa-tags"></i>
                </div>
                <div class="summary-value" id="serviceCount">0</div>
                <div class="summary-label">Services Sold</div>
            </div>
            
            <div class="summary-card glass-card">
                <div class="summary-icon" style="color: #9b59b6;">
                    <i class="fas fa-receipt"></i>
                </div>
                <div class="summary-value" id="transactionCount">0</div>
                <div class="summary-label">Total Transactions</div>
            </div>
            
            <div class="summary-card glass-card">
                <div class="summary-icon" style="color: #f39c12;">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="summary-value" id="averageSale">à§³0</div>
                <div class="summary-label">Average Sale</div>
            </div>
        </div>
        
        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Loading report data...</div>
        </div>
        
        <!-- No Data Message -->
        <div class="no-data glass-card" id="noData" style="display: none;">
            <i class="fas fa-chart-pie"></i>
            <h3>No Sales Data Found</h3>
            <p>No sales recorded for the selected date.</p>
        </div>
        
        <!-- Service-wise Breakdown -->
        <div id="reportContent" style="display: none;">
            <div class="section-title">
                <h2>Service-wise Breakdown</h2>
                <p>Detailed breakdown of sales by service</p>
            </div>
            
            <div class="glass-card">
                <table class="service-table">
                    <thead>
                        <tr>
                            <th width="50">#</th>
                            <th width="60"></th>
                            <th>Service Name</th>
                            <th width="120" style="text-align: center;">Quantity</th>
                            <th width="150" style="text-align: right;">Total Amount</th>
                            <th width="150" style="text-align: right;">Average per Sale</th>
                        </tr>
                    </thead>
                    <tbody id="serviceTableBody">
                        <!-- Service rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Grand Total -->
            <div class="grand-total glass-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 14px; color: var(--text-secondary);">Grand Total for</div>
                        <div style="font-size: 24px; font-weight: 700;" id="reportDateDisplay"></div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; color: var(--text-secondary);">Total Sales Amount</div>
                        <div style="font-size: 42px; font-weight: 800; color: #2ecc71;" id="grandTotal">à§³0</div>
                    </div>
                </div>
            </div>
            
            <!-- Transaction Details -->
            <div class="section-title" style="margin-top: 50px;">
                <h2>Detailed Transactions</h2>
                <p>Individual sales records</p>
            </div>
            
            <div class="glass-card">
                <table class="service-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Service</th>
                            <th>Customer</th>
                            <th style="text-align: right;">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody">
                        <!-- Transaction rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Script -->
    <script>
        // Configuration
        const CONFIG = {
            APP_NAME: 'ShopFlow Reports',
            GOOGLE_SHEETS_URL: localStorage.getItem('shopflow_google_sheets_url') || ''
        };
        
        // DOM Elements
        let reportDate, loadReportBtn, todayReportBtn, yesterdayReportBtn;
        let summaryCards, loading, noData, reportContent;
        let serviceTableBody, transactionTableBody;
        let totalSalesEl, serviceCountEl, transactionCountEl, averageSaleEl;
        let grandTotalEl, reportDateDisplay;
        let toastContainer;
        
        // Initialize
        function init() {
            console.log('ðŸ“Š Initializing Daily Report');
            
            // Get DOM elements
            getDOMElements();
            
            // Setup event listeners
            setupEventListeners();
            
            // Set today's date by default
            setTodayDate();
            
            // Load today's report automatically
            setTimeout(() => {
                loadReportBtn.click();
            }, 500);
        }
        
        function getDOMElements() {
            reportDate = document.getElementById('reportDate');
            loadReportBtn = document.getElementById('loadReportBtn');
            todayReportBtn = document.getElementById('todayReportBtn');
            yesterdayReportBtn = document.getElementById('yesterdayReportBtn');
            summaryCards = document.getElementById('summaryCards');
            loading = document.getElementById('loading');
            noData = document.getElementById('noData');
            reportContent = document.getElementById('reportContent');
            serviceTableBody = document.getElementById('serviceTableBody');
            transactionTableBody = document.getElementById('transactionTableBody');
            totalSalesEl = document.getElementById('totalSales');
            serviceCountEl = document.getElementById('serviceCount');
            transactionCountEl = document.getElementById('transactionCount');
            averageSaleEl = document.getElementById('averageSale');
            grandTotalEl = document.getElementById('grandTotal');
            reportDateDisplay = document.getElementById('reportDateDisplay');
            toastContainer = document.getElementById('toastContainer');
        }
        
        function setupEventListeners() {
            loadReportBtn.onclick = generateReport;
            todayReportBtn.onclick = setTodayDate;
            yesterdayReportBtn.onclick = setYesterdayDate;
            
            // Also generate report when date changes and Enter is pressed
            reportDate.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    generateReport();
                }
            };
        }
        
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            reportDate.value = today;
            generateReport();
        }
        
        function setYesterdayDate() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = yesterday.toISOString().split('T')[0];
            reportDate.value = dateStr;
            generateReport();
        }
        
        async function generateReport() {
            const date = reportDate.value;
            
            if (!date) {
                showToast('Please select a date', 'error');
                return;
            }
            
            // Show loading, hide other sections
            loading.style.display = 'block';
            summaryCards.style.display = 'none';
            noData.style.display = 'none';
            reportContent.style.display = 'none';
            
            try {
                let reportData;
                
                if (CONFIG.GOOGLE_SHEETS_URL) {
                    // Try to get from Google Sheets
                    reportData = await getReportFromGoogleSheets(date);
                    
                    if (!reportData || reportData.error) {
                        // Fallback to localStorage
                        reportData = getReportFromLocalStorage(date);
                    }
                } else {
                    // Use localStorage
                    reportData = getReportFromLocalStorage(date);
                }
                
                // Display the report
                displayReport(date, reportData);
                
            } catch (error) {
                console.error('Error generating report:', error);
                showToast('Error loading report: ' + error.message, 'error');
                
                // Show no data
                loading.style.display = 'none';
                noData.style.display = 'block';
            }
        }
        
        async function getReportFromGoogleSheets(date) {
            if (!CONFIG.GOOGLE_SHEETS_URL) return null;
            
            try {
                const params = new URLSearchParams({
                    method: 'getDailyReport',
                    date: date
                });
                
                const response = await fetch(`${CONFIG.GOOGLE_SHEETS_URL}?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                return data;
                
            } catch (error) {
                console.error('Google Sheets error:', error);
                return null;
            }
        }
        
        function getReportFromLocalStorage(date) {
            // Get sales from localStorage
            const sales = JSON.parse(localStorage.getItem('shopflow_sales') || '[]');
            
            // Filter sales for the selected date
            const dailySales = sales.filter(sale => {
                const saleDate = new Date(sale.date).toLocaleDateString('en-IN');
                const selectedDate = new Date(date).toLocaleDateString('en-IN');
                return saleDate === selectedDate;
            });
            
            if (dailySales.length === 0) {
                return { 
                    success: false, 
                    message: 'No sales found for selected date',
                    sales: []
                };
            }
            
            // Group sales by service
            const serviceGroups = {};
            dailySales.forEach(sale => {
                if (!serviceGroups[sale.service]) {
                    serviceGroups[sale.service] = {
                        service: sale.service,
                        count: 0,
                        totalAmount: 0,
                        sales: []
                    };
                }
                serviceGroups[sale.service].count++;
                serviceGroups[sale.service].totalAmount += parseFloat(sale.amount);
                serviceGroups[sale.service].sales.push(sale);
            });
            
            // Convert to array
            const serviceData = Object.values(serviceGroups);
            
            // Calculate totals
            const totalSales = serviceData.reduce((sum, service) => sum + service.totalAmount, 0);
            const totalTransactions = dailySales.length;
            const averageSale = totalSales / totalTransactions;
            
            return {
                success: true,
                date: date,
                totalSales: totalSales,
                totalTransactions: totalTransactions,
                averageSale: averageSale,
                serviceCount: serviceData.length,
                services: serviceData,
                transactions: dailySales
            };
        }
        
        function displayReport(date, reportData) {
            loading.style.display = 'none';
            
            if (!reportData || !reportData.success || reportData.services.length === 0) {
                noData.style.display = 'block';
                return;
            }
            
            // Format date for display
            const formattedDate = new Date(date).toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            reportDateDisplay.textContent = formattedDate;
            
            // Update summary cards
            totalSalesEl.textContent = 'à§³' + formatNumber(reportData.totalSales);
            serviceCountEl.textContent = reportData.serviceCount;
            transactionCountEl.textContent = reportData.totalTransactions;
            averageSaleEl.textContent = 'à§³' + formatNumber(reportData.averageSale);
            
            // Update service table
            updateServiceTable(reportData.services);
            
            // Update transaction table
            updateTransactionTable(reportData.transactions);
            
            // Update grand total
            grandTotalEl.textContent = 'à§³' + formatNumber(reportData.totalSales);
            
            // Show content
            summaryCards.style.display = 'grid';
            reportContent.style.display = 'block';
            
            console.log('Report generated for:', date, reportData);
        }
        
        function updateServiceTable(services) {
            let html = '';
            let rowNumber = 1;
            
            // Sort services by total amount (descending)
            services.sort((a, b) => b.totalAmount - a.totalAmount);
            
            services.forEach(service => {
                const average = service.totalAmount / service.count;
                const icon = getServiceIcon(service.service);
                
                html += `
                    <tr>
                        <td>${rowNumber++}</td>
                        <td class="service-icon-cell">
                            <i class="${icon}" style="font-size: 20px;"></i>
                        </td>
                        <td>${service.service}</td>
                        <td class="count-cell">
                            <span class="badge" style="background: rgba(67, 97, 238, 0.1); color: #4361ee; padding: 5px 15px; border-radius: 20px; font-weight: 600;">
                                ${service.count}
                            </span>
                        </td>
                        <td class="amount-cell" style="color: #2ecc71;">
                            à§³${formatNumber(service.totalAmount)}
                        </td>
                        <td class="amount-cell" style="color: #3498db;">
                            à§³${formatNumber(average)}
                        </td>
                    </tr>
                `;
            });
            
            serviceTableBody.innerHTML = html;
        }
        
        function updateTransactionTable(transactions) {
            let html = '';
            
            // Sort transactions by time (newest first)
            transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            transactions.forEach(transaction => {
                const time = new Date(transaction.timestamp).toLocaleTimeString('en-IN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                html += `
                    <tr>
                        <td>${time}</td>
                        <td>${transaction.service}</td>
                        <td>${transaction.customer || 'N/A'}</td>
                        <td class="amount-cell">à§³${formatNumber(transaction.amount)}</td>
                    </tr>
                `;
            });
            
            transactionTableBody.innerHTML = html;
        }
        
        function getServiceIcon(serviceName) {
            const serviceIcons = {
                'Photo Print': 'fas fa-image',
                'Photocopy': 'fas fa-copy',
                'Document Print': 'fas fa-file-alt',
                'Scan': 'fas fa-box-tissue',
                'Laminating': 'fas fa-layer-group',
                'Compose': 'fas fa-edit',
                'Frame': 'fas fa-border-all',
                'Mug print': 'fas fa-mug-hot',
                'Crest': 'fas fa-award',
                'T-shirt Print': 'fas fa-tshirt',
                'Online Application': 'fas fa-globe',
                'Others': 'fas fa-ellipsis-h'
            };
            
            return serviceIcons[serviceName] || 'fas fa-tag';
        }
        
        function formatNumber(num) {
            return parseFloat(num).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            toast.innerHTML = `
                <i class="fas ${icons[type] || 'fa-info-circle'} toast-icon"></i>
                <span class="toast-message">${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 400);
            }, 5000);
            
            return toast;
        }
        
        function goBack() {
            window.location.href = 'index.html';
        }
        
        function printReport() {
            window.print();
        }
        
        function exportToPDF() {
            showToast('PDF export feature coming soon!', 'info');
            // You can implement PDF export using jsPDF library
        }
        
        function exportToExcel() {
            const date = reportDate.value;
            const formattedDate = new Date(date).toLocaleDateString('en-IN').replace(/\//g, '-');
            
            // Create CSV content
            let csv = 'Service,Quantity,Total Amount,Average per Sale\n';
            
            // Get service data
            const services = document.querySelectorAll('#serviceTableBody tr');
            services.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const service = cells[2].textContent;
                    const quantity = cells[3].querySelector('.badge')?.textContent || cells[3].textContent;
                    const total = cells[4].textContent.replace('à§³', '');
                    const average = cells[5].textContent.replace('à§³', '');
                    
                    csv += `"${service}",${quantity},${total},${average}\n`;
                }
            });
            
            // Add grand total
            const grandTotal = document.getElementById('grandTotal').textContent.replace('à§³', '');
            csv += `\nGrand Total,,${grandTotal},`;
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Daily_Report_${formattedDate}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('Report exported as CSV!', 'success');
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>